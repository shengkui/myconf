#!/bin/bash
#
# REF: https://blog.debiania.in.ua/posts/2012-07-31-purging-vim-undodir.html
#
# Purge vim's undodir (:help 'undodir', vim >= 7.3) from undofiles that does
# not have corresponding files in the filesystem anymore.
#
set -u

if [ $# -ne 1 ] ;then
    undodir="/home/shengkui.leng/.vim/undo"
else
    undodir="$1"
fi

if [ ! -d "$undodir" ] ;then
    echo "Undodir ($undodir) does not exist (or isn't a directory)." >&2
    exit 2
fi

pushd . > /dev/null
cd "$undodir" || { echo "Failed to enter undodir: $undodir"; exit 3; }

for undofile in * ;do
    #Replace the "%" with "/" to get the real file path.
    filepath=$(echo -n "$undofile" | sed 's#%#/#g')
    if [ ! -e "$filepath" ] ;then
        #echo "$filepath"
        rm -f "$undofile"
    fi
done

popd > /dev/null
